<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="/ASPIRA/js/jquery.min.js"></script>
	<script src="/ASPIRA/js/jquery-ui.min.js"></script>
	<style>
		body {
			font-size: 0.8rem;
		}

		.btn {
			line-height: 0.5rem;
		}

		.table-bordered td,
		.table-bordered th {
			font-size: smaller;
		}

		.filterable .filters input[disabled]::-webkit-input-placeholder {
			color: #333;
		}

		.filterable .filters input[disabled]::-moz-placeholder {
			color: #333;
		}

		.filterable .filters input[disabled]:-ms-input-placeholder {
			color: #333;
		}

		.filterable .filters input[disabled] {
			background-color: transparent;
			border: none;
			cursor: auto;
			box-shadow: none;
			padding: 0;
			height: auto;
		}

		.container-manager {
			width: 83.5%;
			padding-right: 15px;
			padding-left: 15px;
			margin-right: auto;
			margin-left: 17.3%;
			margin-top: 80px;
			margin-top: 80px;
		}

		.table .thead-light th {
			color: #495057;
			background-color: #e9ecef;
			border-color: #dee2e6;
			width: 23px;
		}

		.scroll {
			max-height: 60vh;
			overflow-y: scroll;
			overflow-x: hidden;
		}

		.tablinks {
			background-color: #f1f1f1;
			/* Default background color */
			border: none;
			color: black;
			padding: 10px 20px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 16px;
			transition: background-color 0.3s;
		}

		.tablinks.active {
			background-color: #2084a9;
			color: white;
		}

		.tab {
			overflow: hidden;
			border: 1px solid #ccc;
			background-color: #f2f2f2;
		}

		.tab button {
			background-color: inherit;
			float: left;
			border: none;
			outline: none;
			cursor: pointer;
			padding: 14px 56px;
			transition: 0.3s;
			font-size: 17px;
		}

		.tab button:hover {
			background-color: #ddd;
		}

		.tabcontent {
			display: none;
			padding: 0px;
			border-top: 1px solid #ccc;
		}

		.active {
			background-color: #2084a9;
		}

		#myPieChart {
			width: 100px;
			height: 100px;
		}

		.modal-body {
			flex: 1;
			overflow-y: auto;
			/* Table scrolls inside modal body */
			margin-bottom: 10px;
		}

		.modal-footer {
			text-align: center;
			padding-top: 10px;
		}
	</style>
	<style>
		.modal {
			display: none;
			position: fixed;
			z-index: 1;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.4);
			margin-left: 350px;
		}

		.modal-content {
			background-color: #fefefe;
			margin: 15% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 100%;
			height: 25%;
			margin-left: 200px;
		}

		.modal-content1 {
			background-color: #fefefe;
			margin: 10% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 70%;
			height: 45%;
			margin-left: 200px;
		}

		.modal-pass {
			background-color: #fefefe;
			margin: 15% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 40%;
			height: 25%;
			margin-left: 400PX;
			margin-right: auto;
			border-radius: 10px;
			box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.2);
			font-family: Arial, sans-serif;
		}

		.close {
			color: red;
			font-size: 28px;
			font-weight: bold;
		}

		.close:hover,
		.close:focus {
			color: black;
			text-decoration: none;
			cursor: pointer;
		}
	</style>
	<style>
		.password-info {
			visibility: hidden;
			width: 320px;
			background-color: #333;
			color: #fff;
			text-align: left;
			border-radius: 10px;
			padding: 10px;
			position: absolute;
			z-index: 1;
			top: calc(100% + 10px);
			left: 50%;
			transform: translateX(-50%);
			opacity: 0;
			transition: opacity 0.3s;
		}

		input:hover+.password-info {
			visibility: visible;
			opacity: 0.8;
		}

		.big-btn {
			font-size: 16px;
		}
	</style>
	<script>

		$(function () {
			$("#fromdate").datepicker({
				dateFormat: "dd-mm-yy",
				changeMonth: true,
				changeYear: true,
				onSelect: function (selectedDate) {
					// Set the minDate for the "To Date" based on the selected "From Date"
					$("#todate").datepicker("option", "minDate", selectedDate);
				}
			});

			$("#todate").datepicker({
				dateFormat: "dd-mm-yy",
				changeMonth: true,
				changeYear: true

			});
		});

		function Home() {

			location.href = 'Dashboard';
		}

		function back() {
			window.history.back();
		}

		function add() {

			location.href = './deposits?formmode=add';

		}

		function navigate() {

			location.href = './accountLedger';

		}

		function view(a) {
			var actno = a.getAttribute('data-act');
			location.href = './deposits?formmode=view&actno=' + actno;
		}

		function verify(a) {
			var actno = a.getAttribute('data-act');
			location.href = './deposits?formmode=verify&actno=' + actno;
		}

		function modify(a) {
			var actno = a.getAttribute('data-act');
			location.href = './deposits?formmode=modify&actno=' + actno;
		}

		function clickMe() {
			$('#alert').modal('show');
		}


		function postingvalues(radio) {
			var accountvalue = document.getElementById("depositeaccountno").value;
			var flowCode = radio.getAttribute('data-flow_code');
			var flowDate = radio.getAttribute('data-flow_date');
			var flowAmount = radio.getAttribute('data-flow_amount');
			var currency = document.getElementById('currency').value;

			var url = 'journalEntries?formmode=add&account_no='
				+ encodeURIComponent(accountvalue) + '&flow_code='
				+ encodeURIComponent(flowCode) + '&flow_date='
				+ encodeURIComponent(flowDate) + '&flow_amount='
				+ encodeURIComponent(flowAmount) + '&currency='
				+ encodeURIComponent(currency);
			location.href = url;
		}
	</script>
	<script>

		function callCollectionScreen(a) {
			event.preventDefault();
			location.href = 'leasecollection';
		}

		/* function callflowDetails() {
			getflowDetails();
		} */

		function handleRadioClickInterest(selectedRadio) {
			var flow_amt = selectedRadio.getAttribute("data-flow_amt").replace(/,/g, '');
			var flow_code = selectedRadio.getAttribute("data-flow_code");
			var flow_id = selectedRadio.getAttribute("data-flow_id");
			var flow_date = selectedRadio.getAttribute("data-flow_date");
			var loan_acct_no = selectedRadio.getAttribute("data-loan_acct_no");
			var acct_name = selectedRadio.getAttribute("data-acct_name");
			var operation = selectedRadio.getAttribute("data-operation");

			console.log(flow_amt + " " + flow_code + " " + loan_acct_no + " " + acct_name + " " + flow_date);


			$.ajax({
				type: 'GET',
				url: './transactionInterest',
				data: {
					flow_amount: flow_amt,
					flow_code: flow_code,
					flow_date: flow_date,
					account_no: loan_acct_no,
					accountName: acct_name,
					flow_id: flow_id,
					operation: operation


				},
				success: function (data) {
					console.log(data);

					var tranId = data.trim();
					var parttranid = "1";


					var url = 'accountLedgerPost?formmode=verify' +
						'&acct_num=' + encodeURIComponent(loan_acct_no) +
						'&tran_id=' + encodeURIComponent(tranId) +
						'&part_tran_id=' + encodeURIComponent(parttranid);  // Include tranId in the URL

					// Redirect to the constructed URL
					location.href = url;



				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}


		function handleRadioClickInterestdatas(selectedRadio) {
			// Get the parent row of the selected radio button
			var row = selectedRadio.closest("tr");

			// Fetch values dynamically from input fields within the same row
			var flow_amt = row.querySelector("[name='flow_amt']").value.trim();
			var flow_code = row.querySelector("[name='flow_code']").value.trim();
			var flow_id = row.querySelector("[name='flow_id']").value.trim();
			var flow_date = row.querySelector("[name='flow_date']").value.trim();
			var loan_acct_no = row.querySelector("[name='loan_acct_no']").value.trim();
			var acct_name = row.querySelector("[name='acct_name']").value.trim();

			// Convert flow_date from "YYYY-MM-DD" to "DD-MM-YYYY"
			if (flow_date) {
				let dateParts = flow_date.split("-");
				flow_date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;  // Rearranging to DD-MM-YYYY
			}

			// Debugging alert
			alert("Flow Amount: " + flow_amt +
				"\nFlow Code: " + flow_code +
				"\nFlow ID: " + flow_id +
				"\nFlow Date (Converted): " + flow_date +
				"\nLoan Account No: " + loan_acct_no +
				"\nAccount Name: " + acct_name);

			// AJAX Request
			$.ajax({
				type: 'GET',
				url: './transactionInterest',
				data: {
					flow_amount: flow_amt,
					flow_code: flow_code,
					flow_date: flow_date,
					account_no: loan_acct_no,
					accountName: acct_name,
					flow_id: flow_id
				},
				success: function (data) {
					console.log(data);
					var tranId = data.trim();
					var parttranid = "1";

					var url = 'accountLedgerPost?formmode=verify' +
						'&acct_num=' + encodeURIComponent(loan_acct_no) +
						'&tran_id=' + encodeURIComponent(tranId) +
						'&part_tran_id=' + encodeURIComponent(parttranid);

					// Redirect to the constructed URL
					location.href = url;
				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}

		function handleRadioClickCollection(selectedRadio) {
			var flow_amt = selectedRadio.getAttribute("data-flow_amt").replace(/,/g, '');
			var flow_code = selectedRadio.getAttribute("data-flow_code");
			var flow_id = selectedRadio.getAttribute("data-flow_id");
			var flow_date = selectedRadio.getAttribute("data-flow_date");
			var loan_acct_no = selectedRadio.getAttribute("data-loan_acct_no");
			var acct_name = selectedRadio.getAttribute("data-acct_name");
			var operation = selectedRadio.getAttribute("data-operation");

			console.log(flow_amt + " " + flow_id + " " + flow_code + " " + loan_acct_no + " " + acct_name + " " + flow_date + " " + operation);

			$.ajax({
				type: 'GET',
				url: './transactionCollection',
				data: {
					flow_amount: flow_amt,
					flow_code: flow_code,
					flow_date: flow_date,
					account_no: loan_acct_no,
					accountName: acct_name,
					flow_id: flow_id,
					operation: operation


				},
				success: function (data) {
					console.log(data);

					var tranId = data.trim();
					var parttranid = "1";


					var url = 'accountLedgerPost?formmode=verify' +
						'&acct_num=' + encodeURIComponent(loan_acct_no) +
						'&tran_id=' + encodeURIComponent(tranId) +
						'&part_tran_id=' + encodeURIComponent(parttranid);  // Include tranId in the URL

					// Redirect to the constructed URL
					location.href = url;



				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}

		function handleRadioClickBooking(selectedRadio) {
			var flow_amt = selectedRadio.getAttribute("data-flow_amt").replace(/,/g, '');
			var flow_code = selectedRadio.getAttribute("data-flow_code");
			var flow_id = selectedRadio.getAttribute("data-flow_id");
			var flow_date = selectedRadio.getAttribute("data-flow_date");
			var loan_acct_no = selectedRadio.getAttribute("data-loan_acct_no");
			var acct_name = selectedRadio.getAttribute("data-acct_name");
			var operation = selectedRadio.getAttribute("data-operation");
			var interest = selectedRadio.getAttribute("data-interest");
			var days = selectedRadio.getAttribute("data-days");

			console.log(flow_amt + " " + flow_code + " " + loan_acct_no + " " + acct_name + " " + flow_date);


			$.ajax({
				type: 'GET',
				url: './transactionBooking',
				data: {
					flow_amount: flow_amt,
					flow_code: flow_code,
					flow_date: flow_date,
					account_no: loan_acct_no,
					accountName: acct_name,
					flow_id: flow_id,
					operation: operation,
					interest: interest,
					days: days


				},
				success: function (data) {
					console.log(data);

					var array = data.split(',');

					var tranId = array[0].trim();
					var ActNo = array[1].trim();
					var parttranid = "1";


					var url = 'accountLedgerPost?formmode=verify' +
						'&acct_num=' + encodeURIComponent(ActNo) +
						'&tran_id=' + encodeURIComponent(tranId) +
						'&part_tran_id=' + encodeURIComponent(parttranid);  // Include tranId in the URL

					// Redirect to the constructed URL
					location.href = url;



				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}

		function formatDateToDD(dateString) {

			var parts = dateString.split('-');

			return parts[2] + '-' + parts[1] + '-' + parts[0];
		}

		function formatNumberWithCommas(number) {

			if (!number && number !== 0) return '';
			console.log("number : " + number);
			let numberString = number.toString();
			console.log("numberString : " + numberString);

			let [integerPart, decimalPart] = numberString.split('.');

			let lastThreeDigits = integerPart.slice(-3);
			let otherDigits = integerPart.slice(0, -3);

			if (otherDigits !== '') {
				lastThreeDigits = ',' + lastThreeDigits;
			}

			let formattedIntegerPart = otherDigits.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + lastThreeDigits;

			if (!decimalPart) {
				decimalPart = '00';
			}
			let formattedNumber = formattedIntegerPart + '.' + decimalPart;
			console.log("formattedIntegerPart : " + formattedIntegerPart);
			console.log("decimalPart : " + decimalPart);

			return formattedNumber;
		}

		function formatDate(dateString) {

			var date = new Date(dateString);


			var day = date.getDate();
			var month = date.getMonth() + 1;
			var year = date.getFullYear();


			if (day < 10) {
				day = '0' + day;
			}
			if (month < 10) {
				month = '0' + month;
			}

			return day + '-' + month + '-' + year;
		}
	</script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			let today = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format
			document.getElementById("flowDateInput").value = today; // Set default value
		});
	</script>
	<script th:inline="javascript">

		/* <![CDATA[ */
		// Convert the Thymeleaf variable to a JavaScript date
		var trandate = /*[[${TRANDATE}]]*/'1970-01-01';

		// Function to format date as yyyy-MM-dd
		function formatForInput(date) {
			var d = new Date(date);
			var day = ('0' + d.getDate()).slice(-2);
			var month = ('0' + (d.getMonth() + 1)).slice(-2);
			var year = d.getFullYear();
			return `${year}-${month}-${day}`;
		}

		// Function to format date as dd-MM-yyyy
		function formatDatedd(date) {
			var d = new Date(date);
			var day = ('0' + d.getDate()).slice(-2);
			var month = ('0' + (d.getMonth() + 1)).slice(-2);
			var year = d.getFullYear();
			return `${day}-${month}-${year}`;
		}

		document.addEventListener("DOMContentLoaded", function () {
			// Get today's date

			const formattedDate = formatDatedd(trandate);

			// Display today's date in dd-mm-yyyy format
			document.getElementById('fromdate').value = formattedDate;
			document.getElementById('todate').value = formattedDate;

			document.getElementById('interest').checked = true;
			document.getElementById('loan').checked = true;
			document.getElementById('officeRouting').checked = true;




			getflowDetails();
		});


		/* ]]> */



	</script>
	<script>
		function updateAccountName(selectElement) {
			var selectedOption = selectElement.options[selectElement.selectedIndex];

			console.log("Selected Option HTML:", selectedOption.outerHTML); // Debugging step

			// Retrieve account name using correct attribute
			var accountName = selectedOption.getAttribute("data-acct-namevalues") || "";

			console.log("Retrieved Account Name (data-acct-name):", accountName); // Debugging output

			// Update account name input field
			document.getElementById("acct_name").value = accountName;
		}

		function updateAccountName1(selectElement) {
			var selectedOption = selectElement.options[selectElement.selectedIndex];

			console.log("Selected Option HTML:", selectedOption.outerHTML); // Debugging step

			// Retrieve account name using correct attribute
			var accountName = selectedOption.getAttribute("data-acct-namevalues") || "";

			console.log("Retrieved Account Name (data-acct-name):", accountName); // Debugging output

			// Update account name input field
			document.getElementById("acct_name1").value = accountName;
		}

		function handleCheckboxClickCollectiondata() {
			// Show confirmation modal before proceeding
			$('#confirmation_modal').modal('show');

			// Handle the "Yes" button click to proceed
			$('#confirmYesBtn').off('click').on('click', function () {
				proceedWithTransaction();
			});

			// Handle the "No" button click to refresh the page
			$('#confirmNoBtn').off('click').on('click', function () {
				location.reload(); // Refresh the current page
			});
		}

		function proceedWithTransaction() {
			var loanBal = parseFloat(document.getElementById("loan_bal").value.replace(/,/g, '')) || 0;
			var acctBalance = parseFloat(document.getElementById("acct_balancedatas").value.replace(/,/g, '')) || 0;

			var selectedData = [];

			$("#flowIdTbodynew tr").each(function (index) {
				var row = $(this);
				let flowAmt = row.find("input[name='flow_amt']").val() || row.find("input[name='flow_amtvals']").val();

				if (!flowAmt) return true; // Skip if no amount

				let encodedKey = encodedKeys1[index] || '';

				let rowData = {
					row_index: index + 1,
					flow_amt: flowAmt.replace(/,/g, ''), // Remove commas
					flow_code: row.find("input[name='flow_code']").val() || '',
					flow_date: row.find("input[name='flow_date']").val() || '',
					flow_id: row.find("input[name='flow_id']").val() || '',
					loan_acct_no: row.find("input[name='loan_acct_no']").val() || '',
					acct_name: row.find("input[name='acct_name']").val() || '',
					encoded_key: encodedKey
				};

				console.log("Row " + (index + 1) + " Data:", rowData);
				selectedData.push(rowData);
			});

			if (selectedData.length === 0) {
				alert("No data found in the table.");
				console.log("No data rows found.");
				return;
			}

			// Compare absolute values and process accordingly
			if (Math.abs(loanBal) === Math.abs(acctBalance)) {
				processTransaction('./transactionCollectiondatas121', selectedData);
			} else {
				processTransaction('./transactionCollectiondatas1211', selectedData);
			}
		}

		// Function to handle AJAX transaction request
		function processTransaction(url, selectedData) {
			$.ajax({
				type: 'POST',
				url: url,
				contentType: 'application/json',
				data: JSON.stringify(selectedData),
				success: function (data) {
					var tranId = data.trim(); // assign tranId from response

					// Show success modal with tran_id
					$('#successModalBody').text("Transaction saved successfully! Tran ID: " + tranId);
					$('#successModal').modal('show');

					// Close button (X) reloads the page
					$('#successModalCloseBtn').off('click').on('click', function () {
						location.reload();
					});

					// Close button (footer) reloads the page
					$('#successModalCloseBtnFooter').off('click').on('click', function () {
						location.reload();
					});
				},
				error: function () {
					$('#errorMessage').text('Error saving transaction');
					$('#errorModal').modal('show');
				}
			});
		}


		function handleCheckboxClickCollectiondata1() {
			// Show confirmation modal before proceeding
			$('#confirmation_modal').modal('show');

			// Handle "Yes" button click to proceed
			$('#confirmYesBtn').off('click').on('click', function () {
				proceedWithTransaction1();
			});

			// Handle "No" button click to refresh the page
			$('#confirmNoBtn').off('click').on('click', function () {
				location.reload(); // Refresh the page
			});
		}

		function proceedWithTransaction1() {
			var loanBal = parseFloat(document.getElementById("loan_bal1").value.replace(/,/g, '')) || 0;
			var acctBalance = parseFloat(document.getElementById("acct_balancedatas1").value.replace(/,/g, '')) || 0;

			var processRows = [];

			$("#flowIdTbodynew1 tr").each(function (index) {
				var row = $(this);
				let flowAmt = row.find("input[name='flow_amt']").val() || row.find("input[name='flow_amtvals']").val();

				if (!flowAmt) return true; // Skip row if no amount

				let encodedKey = encodedKeys[index] || '';

				let rowData = {
					flow_amt: flowAmt.replace(/,/g, ''), // Remove commas
					flow_code: row.find("input[name='flow_code']").val() || '',
					flow_date: row.find("input[name='flow_date']").val() || '',
					flow_id: row.find("input[name='flow_id']").val() || '',
					loan_acct_no: row.find("input[name='loan_acct_no']").val() || '',
					acct_name: row.find("input[name='acct_name']").val() || '',
					encoded_key: encodedKey
				};

				processRows.push(rowData);
			});

			if (processRows.length === 0) {
				alert("No rows to process.");
				return;
			}

			console.log("Loan Balance:", loanBal);
			console.log("Preclosure Balance:", acctBalance);
			console.log("Encoded Keys being sent:", processRows.map(r => r.encoded_key));

			// ✅ Compare absolute values (treat -2000 and 2000 as same)
			let url = (Math.abs(loanBal) === Math.abs(acctBalance))
				? './transactionCollectiondatas1212'   // SAME AMOUNT
				: './transactionCollectiondatas1221';  // DIFFERENT AMOUNT

			$.ajax({
				type: 'POST',
				url: url,
				contentType: 'application/json',
				data: JSON.stringify(processRows),
				success: function (data) {
					var tranId = data.trim();
					$('#successModalBody').text("Transaction saved successfully! Tran ID: " + tranId);
					$('#successModal').modal('show');

					$('#successModalCloseBtn, #successModalCloseBtnFooter').off('click').on('click', function () {
						location.reload();
					});
				},
				error: function () {
					$('#errorMessage').text('Error saving transaction');
					$('#errorModal').modal('show');
				}
			});
		}

		// Global array to store encoded_keys
		var encodedKeys1 = [];

		function fetchacctnum() {
			var acctnum = $("#precosureaccount").val();
			var acctName = $("#preclosurename").val();

			console.log("Account No:", acctnum);
			console.log("Account Name:", acctName);

			// Fetch account balance
			$.ajax({
				type: 'GET',
				url: './fetchacctbalance',
				data: {acctnum: acctnum},
				success: function (balanceData) {
					var formattedBalance = parseFloat(balanceData || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
					$("#loan_bal").val(formattedBalance);
					$("#repaymentschedule").show();
					$("#ledgerschedule").show();

					// Fetch loan flow details
					$.ajax({
						type: 'GET',
						url: './getloanclosetdatas5211',
						data: {accountNumber: acctnum},
						success: function (data) {
							var tHTML = "";

							if (data.loan_flows && data.loan_flows.length > 0) {
								data.loan_flows.forEach(function (entity) {
									var flowDate = entity.flow_date ? formatDate(entity.flow_date) : "";
									var flowAmount = entity.flow_amt ? formatNumberWithCommas(entity.flow_amt) : "0.00";

									let encoded_key = entity.encoded_key || ''; // store encoded_key for this row

									// Push encoded_key to global array
									encodedKeys1.push(encoded_key);

									tHTML += "<tr>"
										+ "<td><input type='text' name='flow_date' value='" + flowDate + "' class='border-0' readonly /></td>"
										+ "<td><input type='text' name='flow_id' value='" + entity.flow_id + "' class='border-0' readonly /></td>"
										+ "<td><input type='text' name='flow_code' value='" + entity.flow_code + "' class='border-0' readonly /></td>"
										+ "<td style='text-align: right;'><input type='text' name='flow_amtvals' value='" + flowAmount + "' class='border-0 text-right' readonly /></td>"
										+ "<td><input type='text' name='loan_acct_no' value='" + (entity.loan_acct_no || "") + "' class='border-0' readonly /></td>"
										+ "<td><input type='text' name='acct_name' value='" + (entity.acct_name || "") + "' class='border-0' readonly /></td>"
										+ "</tr>";

								});
							} else {
								tHTML = "<tr><td colspan='7'>No records available</td></tr>";
							}

							$("#flowIdTbodynew").empty().append(tHTML);
							$("#acct_balancedatas").val(parseFloat(data.flow_total_amt || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
						},
						error: function () {
							alert("Error fetching loan flow data");
						}
					});
				},
				error: function () {
					alert("Error fetching account balance");
					$("#loan_bal").val("");
				}
			});
		}

		// Global array to store encoded_keys
		var encodedKeys = [];

		function fetchacctnum1() {
			var acctnum = document.getElementById("closureaccountnumber").value;

			$.ajax({
				type: 'GET',
				url: './fetchacctbalance',
				data: {acctnum: acctnum},
				success: function (data) {
					var formattedBalance = parseFloat(data).toLocaleString('en-US', {
						minimumFractionDigits: 2,
						maximumFractionDigits: 2
					});

					document.getElementById("loan_bal1").value = formattedBalance;

					$.ajax({
						type: 'GET',
						url: './getloanclosetdatas521',
						data: {accountNumber: acctnum},
						success: function (data) {
							console.log(data);

							// ✅ Safely handle total amount field
							let formattedTotalAmount = parseFloat(data.flow_total_amt || "0.00").toLocaleString('en-US', {
								minimumFractionDigits: 2,
								maximumFractionDigits: 2
							});

							let balanceField = document.getElementById("acct_balancedatas1");
							if (balanceField) {
								balanceField.value = formattedTotalAmount;
							}

							let tHTML = "";
							let tranDate = data.tran_date ? formatDate(data.tran_date) : "";

							if (data.loan_flows && data.loan_flows.length > 0) {
								$.each(data.loan_flows, function (index, entity) {
									let flowDate = entity.flow_date ? formatDate(entity.flow_date) : "";
									let flowCode = entity.flow_code || "";
									let flowAmount = entity.flow_amt ? formatNumberWithCommas(entity.flow_amt) : "0.00";
									let acctNo = entity.loan_acct_no || "";
									let acctName = entity.acct_name || "";
									let encoded_key = entity.encoded_key || ''; // store encoded_key for this row

									// Push encoded_key to global array
									encodedKeys.push(encoded_key);

									let isEditable = (flowCode === "FEEDEM" && flowDate === tranDate);

									tHTML += `
									    <tr>
									        <td><input type="text" name="flow_date" value="${flowDate}" class="border-0" readonly style="white-space: nowrap;" /></td>
									        <td><input type="text" name="flow_id" value="${entity.flow_id || ""}" class="border-0" readonly style="white-space: nowrap;" /></td>
									        <td><input type="text" name="flow_code" value="${flowCode}" class="border-0" readonly style="white-space: nowrap;" /></td>
									        <td style="text-align: right; white-space: nowrap;">
									            ${isEditable
											? `<input type="number" name="flow_amt" value="${flowAmount}" class="border text-right" onchange="updateFeeDemAmount(this)" />`
											: `<input type="text" name="flow_amt" value="${flowAmount}" class="border-0 text-right" readonly />`}
									        </td>
									        <td><input type="text" name="loan_acct_no" value="${acctNo}" class="border-0" readonly style="white-space: nowrap;" /></td>
									        <td><input type="text" name="acct_name" value="${acctName}" class="border-0" readonly style="white-space: nowrap;" /></td>
									    </tr>`;
								});
							} else {
								tHTML = "<tr><td colspan='7'>No records available</td></tr>";
							}

							// ✅ Only append if table body exists
							if ($("#flowIdTbodynew1").length) {
								$("#flowIdTbodynew1").empty().append(tHTML);
							}

							// ✅ Safely hide loading modal (only if it exists)
							let loadingModal = document.getElementById("loadingModal");
							if (loadingModal) {
								loadingModal.style.display = 'none';
							}
						},
						error: function () {
							if ($('#errorMessage').length && $('#errorModal').length) {
								$('#errorMessage').text('Error fetching loan data');
								$('#errorModal').modal('show');
							}
						}
					});
				},
				error: function () {
					$('#errorMessage').text('Error fetching account balance');
					$('#errorModal').modal('show');
				}
			});
		}
	</script>
	<script type="text/javascript">
		//preclosure add row and delete row
		function addloanRow() {
			var accountNumber = document.getElementById("precosureaccount").value;

			$.ajax({
				type: 'GET',
				url: './getloanclosetdatas511',
				data: {accountNumber: accountNumber},
				success: function (data) {
					let tbody = document.getElementById("flowIdTbodynew"); // Correct tbody reference

					let newRow = tbody.insertRow(); // Insert row into tbody
					newRow.classList.add("deletable-row");

					newRow.innerHTML = `
		                <td><input type="text" name="flow_date" class="border-0" value="${data.tran_date || ''}" readonly></td>
		                <td><input type="text" name="flow_id" value="5" class="border-0" readonly /></td>
		                <td><input type="text" name="flow_code" value="PENDEM" class="border-0" readonly /></td>
		                <td style="text-align:right;">
		                    <input type="text" name="flow_amtvals" class="border-0 text-right" />
		                </td>
		                <td><input type="text" name="loan_acct_no" class="border-0" value="${data.loan_data[0] || ''}" readonly /></td>
		                <td><input type="text" name="acct_name" class="border-0" value="${data.loan_data[1] || ''}" readonly /></td>
		            `;

					flowCounter1++;

					let amountInput = newRow.querySelector("input[name='flow_amtvals']");
					amountInput.addEventListener("input", updateBalance);
					amountInput.addEventListener("blur", function () {
						formatAmountAndUpdate(this);
						updateBalance();
					});

					updateBalance();
				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}


		function updateBalance() {
			let total = 0;

			let balanceElem = document.getElementById("acct_balancedatas");

			if (!balanceElem) {
				console.error("Error: Balance field not found!");
				return;
			}

			// Get the original balance only if it's not already set
			if (!balanceElem.dataset.originalBalance) {
				balanceElem.dataset.originalBalance = balanceElem.value.replace(/,/g, "") || "0";
			}

			let initialBalance = parseFloat(balanceElem.dataset.originalBalance) || 0;

			// Loop through all input fields with name 'flow_amtvals' and sum their values
			document.querySelectorAll("input[name='flow_amtvals']").forEach(input => {
				let value = parseFloat(input.value.replace(/,/g, "")) || 0;
				total += value;
			});

			let finalBalance = initialBalance + total;

			// Debugging - Ensure values are updating correctly
			console.log("Initial Balance:", initialBalance);
			console.log("Total Flow Amount:", total);
			console.log("Final Balance:", finalBalance);

			// Update the loan balance field with the new total
			balanceElem.value = finalBalance.toLocaleString('en-US', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});
		}


		function formatAmountAndUpdate(input) {
			let value = input.value.replace(/,/g, "").trim();
			if (value !== "" && !isNaN(value)) {
				input.value = parseFloat(value).toLocaleString('en-US', {
					minimumFractionDigits: 2,
					maximumFractionDigits: 2
				});
			} else {
				input.value = ""; // Clear field if empty
			}
		}

		function deleteloanRow() {
			let table = document.getElementById("serviceflowIdTable");

			// Ensure at least 2 rows remain
			if (table.getElementsByClassName("deletable-row").length <= 0) {
				alert("At least 1 dynamically added row must remain.");
				return;
			}

			// Find the last dynamically added row
			let rows = table.getElementsByClassName("deletable-row");
			if (rows.length > 0) {
				let lastRow = rows[rows.length - 1];

				// Get the amount from the deleted row
				let deletedAmountInput = lastRow.querySelector("input[name='flow_amtvals']");
				let deletedAmount = deletedAmountInput ? parseFloat(deletedAmountInput.value.replace(/,/g, "")) || 0 : 0;

				// Remove the row
				lastRow.remove();

				// Update balance after row removal
				updateBalanceAfterDeletion(deletedAmount);
			}
		}

		function updateBalanceAfterDeletion(deletedAmount) {
			let balanceElem = document.getElementById("acct_balancedatas");

			if (!balanceElem) {
				console.error("Error: Balance field not found!");
				return;
			}

			// Get the original balance
			let currentBalance = parseFloat(balanceElem.value.replace(/,/g, "")) || 0;

			// Subtract the deleted amount
			let newBalance = currentBalance - deletedAmount;

			// Debugging log
			console.log("Deleted Amount:", deletedAmount);
			console.log("Updated Balance:", newBalance);

			// Update the balance field
			balanceElem.value = newBalance.toLocaleString('en-US', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});
		}

		//Function to add a new row
		function addloanRowclosure() {
			var accountNumber = document.getElementById("closureaccountnumber").value;

			$.ajax({
				type: 'GET',
				url: './getloanclosetdatas511',
				data: {accountNumber: accountNumber},
				success: function (data) {
					let tbody = document.getElementById("flowIdTbodynew1"); // Correct tbody reference

					let newRow = tbody.insertRow(); // Insert row into tbody
					newRow.classList.add("deletable-row");


					newRow.innerHTML = `
					    <td><input type="text" name="flow_date" value="${data.tran_date || ''}" readonly style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; border: none; background: transparent;"></td>
					    <td><input type="text" name="flow_id" value="5" readonly style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; border: none; background: transparent;"></td>
					    <td><input type="text" name="flow_code" value="PENDEM" readonly style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; border: none; background: transparent;"></td>
					    <td style="text-align:right;">
					        <input type="text" name="flow_amtvals" style="width: 100%; text-align: right;border:none;">
					    </td>
					    <td><input type="text" name="loan_acct_no" value="${data.loan_data[0]}" readonly style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; border: none; background: transparent;"></td>
					    <td><input type="text" name="acct_name" value="${data.loan_data[1]}" readonly style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; border: none; background: transparent;"></td>
					`;

					flowCounter1++;

					let amountInput = newRow.querySelector("input[name='flow_amtvals']");
					amountInput.addEventListener("input", updateBalance);
					amountInput.addEventListener("blur", function () {
						formatAmountAndUpdate(this);
						updateBalance();
					});

					updateBalance();
				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}

		function updateBalance() {
			let total = 0;

			let balanceElem = document.getElementById("acct_balancedatas1");

			if (!balanceElem) {
				console.error("Error: Balance field not found!");
				return;
			}

			// Get the original balance only if it's not already set
			if (!balanceElem.dataset.originalBalance) {
				balanceElem.dataset.originalBalance = balanceElem.value.replace(/,/g, "") || "0";
			}

			let initialBalance = parseFloat(balanceElem.dataset.originalBalance) || 0;

			// Loop through all input fields with name 'flow_amtvals' and sum their values
			document.querySelectorAll("input[name='flow_amtvals']").forEach(input => {
				let value = parseFloat(input.value.replace(/,/g, "")) || 0;
				total += value;
			});

			let finalBalance = initialBalance + total;

			// Debugging - Ensure values are updating correctly
			console.log("Initial Balance:", initialBalance);
			console.log("Total Flow Amount:", total);
			console.log("Final Balance:", finalBalance);

			// Update the loan balance field with the new total
			balanceElem.value = finalBalance.toLocaleString('en-US', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});
		}


		function formatAmountAndUpdate(input) {
			let value = input.value.replace(/,/g, "").trim();
			if (value !== "" && !isNaN(value)) {
				input.value = parseFloat(value).toLocaleString('en-US', {
					minimumFractionDigits: 2,
					maximumFractionDigits: 2
				});
			} else {
				input.value = ""; // Clear field if empty
			}
		}

		let flowCounter1 = 4; // Initialize flow_id starting from 2

		let flowCounter = 3; // Initialize flow_id starting from 2

		function deleteloanRowclosure() {
			let tbody = document.getElementById("flowIdTbodynew1"); // Correct tbody reference
			// Ensure at least 2 rows remain
			if (table.getElementsByClassName("deletable-row").length <= 0) {
				alert("At least 1 dynamically added row must remain.");
				return;
			}

			// Find the last dynamically added row
			let rows = table.getElementsByClassName("deletable-row");
			if (rows.length > 0) {
				let lastRow = rows[rows.length - 1];

				// Get the amount from the deleted row
				let deletedAmountInput = lastRow.querySelector("input[name='flow_amtvals']");
				let deletedAmount = deletedAmountInput ? parseFloat(deletedAmountInput.value.replace(/,/g, "")) || 0 : 0;

				// Remove the row
				lastRow.remove();

				// Update balance after row removal
				updateBalanceAfterDeletion(deletedAmount);
			}
		}

		function updateBalanceAfterDeletion(deletedAmount) {
			let balanceElem = document.getElementById("acct_balancedatas1");

			if (!balanceElem) {
				console.error("Error: Balance field not found!");
				return;
			}

			// Get the original balance
			let currentBalance = parseFloat(balanceElem.value.replace(/,/g, "")) || 0;

			// Subtract the deleted amount
			let newBalance = currentBalance - deletedAmount;

			// Debugging log
			console.log("Deleted Amount:", deletedAmount);
			console.log("Updated Balance:", newBalance);

			// Update the balance field
			balanceElem.value = newBalance.toLocaleString('en-US', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});
		}
		/* // Ensure existing inputs update the balance when typing
		document.addEventListener("DOMContentLoaded", function () {
			document.querySelectorAll("input[name='flow_amtvals']").forEach(input => {
				input.addEventListener("input", updateBalance);
				input.addEventListener("blur", function () {
					formatAmountAndUpdate(this);
				});
			});
		});
		 */
	</script>
	<script>
		function showPreClosure() {
			document.getElementById("preclosuredatas").style.display = "block";
			document.getElementById("closuredatas").style.display = "none";
			document.getElementById("loanHeader").innerHTML = "LOAN PRE - CLOSURE";

			// Hide Closure buttons
			document.getElementById('closeRepaymentSchedule').style.display = 'none';
			document.getElementById('closeLedgerSchedule').style.display = 'none';

			// Show Pre-Closure buttons
			document.getElementById('preRepaymentSchedule').style.display = 'inline-block';
			document.getElementById('preLedgerSchedule').style.display = 'inline-block';
		}

		function showClosure() {
			document.getElementById("preclosuredatas").style.display = "none";
			document.getElementById("closuredatas").style.display = "block";
			document.getElementById("loanHeader").innerHTML = "LOAN CLOSURE";

			// Hide Pre-Closure buttons
			document.getElementById('preRepaymentSchedule').style.display = 'none';
			document.getElementById('preLedgerSchedule').style.display = 'none';

			// Show Closure buttons
			document.getElementById('closeRepaymentSchedule').style.display = 'inline-block';
			document.getElementById('closeLedgerSchedule').style.display = 'inline-block';
		}

		function openModalpreclosure(a) {
			event.preventDefault();

			var modal = document.getElementById("myModalpreclosure");
			modal.style.display = "block";

		}

		function closeModalpreclosure(a) {
			event.preventDefault();

			var modal = document.getElementById("myModalpreclosure");
			modal.style.display = "none";

		}

		function openModalclosure(a) {
			event.preventDefault();

			var modal = document.getElementById("myModalclosure");
			modal.style.display = "block";

		}

		function closeModalclosure(a) {
			event.preventDefault();

			var modal = document.getElementById("myModalclosure");
			modal.style.display = "none";

		}
	</script>
	<script>
		function openModal1(a) {
			event.preventDefault();

			var modal = document.getElementById("myModal");
			modal.style.display = "block";

		}

		$(document)
			.ready(
				function () {
					$('.filterable .btn-filter').click(function (event) {
						event.preventDefault(); // Prevent the default action of the button

						var $panel = $(this).parents('.filterable');
						var $filters = $panel.find('.filters input');
						var $tbody = $panel.find('.table tbody');

						if ($filters.prop('readonly') == true) {
							$filters.prop('readonly', false);
							$filters.first().focus();
						} else {
							$filters.val('').prop('readonly', true);
							$tbody.find('.no-result').remove();
							$tbody.find('tr').show();
						}
					});

					$('.filterable .filters input')
						.keyup(
							function (e) {
								/* Ignore tab key */
								var code = e.keyCode || e.which;
								if (code == '9')
									return;
								/* Useful DOM data and selectors */
								var $input = $(this), inputContent = $input
									.val().toLowerCase(), $panel = $input
										.parents('.filterable'), column = $panel
											.find('.filters th')
											.index($input.parents('th')), $table = $panel
												.find('.table'), $rows = $table
													.find('tbody tr');
								/* Dirtiest filter function ever ;)  */
								var $filteredRows = $rows
									.filter(function () {
										var value = $(this)
											.find('td').eq(
												column)
											.text()
											.toLowerCase();
										return value
											.indexOf(inputContent) === -1;
									});
								/* Clean previous no-result if exist */
								$table.find('tbody .no-result')
									.remove();
								/* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
								$rows.show();
								$filteredRows.hide();
								/* Prepend no-result row if all rows are filtered */
								if ($filteredRows.length === $rows.length) {
									$table
										.find('tbody')
										.prepend(
											$('<tr class="no-result text-center"><td colspan="'
												+ $table
													.find('.filters th').length
												+ '">No result found</td></tr>'));
								}
							});
				});

	</script>
	<script>
		function setAccountDetails(a) {
			// ✅ Get values from the clicked radio
			var acct_num = a.getAttribute("data-acct_num");
			var acct_name = a.getAttribute("data-acct_name");
			var acct_crncy = a.getAttribute("data-acct_crncy");

			// ✅ Set values to input fields by ID
			$("#acct_num1234").val(acct_num);
			$("#acct_name").val(acct_name);
			$("#acct_crncy").val(acct_crncy); // if you have a currency field

			// ✅ Close modal
			document.getElementById("myModal").style.display = "none";
		}
	</script>
	<script>
		// Function to close the modal
		function closeModal(button) {
			// Find the closest parent modal
			const modal = button.closest('.modal');
			if (modal) {
				modal.style.display = 'none';
			}
		}

		// Optional: Click outside the modal to close it
		window.addEventListener('click', function (event) {
			const modal = document.getElementById('myModal');
			if (event.target === modal) {
				modal.style.display = 'none';
			}
		});


		function selectAccountpreclosure(row) {
			// Get account number and name from the clicked row
			var accountNumber = row.cells[0].textContent.trim();
			var accountName = row.cells[1].textContent.trim();

			// Populate selected values
			$("#precosureaccount").val(accountNumber);          // Account number field
			$("#preclosurename").val(accountName);             // Account name input field

			// Close the modal
			closeModalpreclosure(document.getElementById("myModalpreclosure"));

			// Trigger main AJAX function to load related data
			fetchacctnum();

			// Show the submit button
			$("#preclosuresubmit").show();
		}

		function selectAccountclosure(row) {
			// Get account number and name from the clicked row
			var accountNumber = row.cells[0].textContent.trim();
			var accountName = row.cells[1].textContent.trim();

			// Populate selected values
			$("#closureaccountnumber").val(accountNumber);          // Account number field
			$("#closureaccountname").val(accountName);             // Account name input field

			// Close the modal
			closeModalclosure(document.getElementById("myModalclosure"));

			// Trigger main AJAX function to load related data
			fetchacctnum1();

			// Show the submit button
			$("#closuresubmit").show();
		}
	</script>
	<script>
		// $(document).ready(function () {
		// 	// Prevent page reload and toggle readonly state on Filter button click
		// 	$('#myModalpreclosure').on('click', '.btn-filter', function (event) {
		// 		event.preventDefault(); // ✅ stops page reload or navigation
		// 		event.stopPropagation(); // ✅ prevents modal focus issues

		// 		var $panel = $(this).closest('.filterable');
		// 		var $filters = $panel.find('.filters input');

		// 		// Toggle readonly state
		// 		var isReadonly = $filters.first().prop('readonly');

		// 		if (isReadonly) {
		// 			// Enable filters
		// 			$filters.prop('readonly', false).val('');
		// 			$filters.first().focus();
		// 		} else {
		// 			// Disable filters and reset
		// 			$filters.prop('readonly', true).val('');
		// 			$panel.find('tbody tr').show();
		// 			$panel.find('.no-result').remove();
		// 		}
		// 	});

		// 	// Filter rows dynamically as user types
		// 	$('#filterAccountNumberpreclosure, #filterAccountNamepreclosure').on('input', function () {
		// 		filterModalRows();
		// 	});

		// 	function filterModalRows() {
		// 		var accountNumber = $('#filterAccountNumberpreclosure').val().toUpperCase();
		// 		var accountName = $('#filterAccountNamepreclosure').val().toUpperCase();

		// 		var $rows = $('#myModalpreclosure tbody tr');
		// 		var anyVisible = false;

		// 		$rows.each(function () {
		// 			var colNumber = $(this).find('td').eq(0).text().toUpperCase();
		// 			var colName = $(this).find('td').eq(1).text().toUpperCase();

		// 			if (colNumber.includes(accountNumber) && colName.includes(accountName)) {
		// 				$(this).show();
		// 				anyVisible = true;
		// 			} else {
		// 				$(this).hide();
		// 			}
		// 		});

		// 		// Show "No result found" row if nothing matches
		// 		$('#myModalpreclosure tbody .no-result').remove();
		// 		if (!anyVisible) {
		// 			var colspan = $('#myModalpreclosure thead th').length;
		// 			$('#myModalpreclosure tbody').prepend(
		// 				`<tr class="no-result text-center"><td colspan="${colspan}">No result found</td></tr>`
		// 			);
		// 		}
		// 	}
		// });

	</script>
	<!--PRE CLOSURE SCHEDULE AND LEDGER CODE-->
	<script>
		function schedulePreClosure(event) {
			event.preventDefault();

			var id = $("#precosureaccount").val().trim();

			if (!id) {
				$('#mypopup22').modal('show');
				$("#popupmsg_body").html("Account number is required!...");
				return;
			}

			$.ajax({
				type: 'GET',
				url: './FetchLoanDetails',
				data: {id: id},
				success: function (data) {
					if (data.account_holderkey && data.encoded_key) {
						var holder_key = data.account_holderkey;
						var encodedKey = data.encoded_key;
						var id = data.id;

						location.href = 'loanSchedule?formmode=viewloanschedule1&id=' + id +
							'&holder_key=' + holder_key +
							'&encodedKey=' + encodedKey;
					} else {
						$('#mypopup22').modal('show');
						$("#popupmsg_body").html("No Data!...");
					}
				},
				error: function () {
					$('#errorMessage').text('Error fetching data');
					$('#errorModal').modal('show');
				}
			});
		}

		function ledgerPreClosure(event) {
			event.preventDefault();

			var id = $("#precosureaccount").val().trim();

			if (!id) {
				$('#mypopup22').modal('show');
				$("#popupmsg_body").html("Account number is required!...");
				return;
			}

			location.href = 'accountLedger2?formmode=view&acct_num=' + id;
		}
	</script>

	<script>
		function scheduleClosure(event) {
			event.preventDefault();
			console.log("Schedule Closure function called");
			var element = document.getElementById("closureaccountnumber");

			if (element) {
				var id = element.value.trim();

				if (!id) {
					console.log("Account number is required");
					$('#mypopup22').modal('show');
					$("#popupmsg_body").html("Account number is required!...");
				} else {
					console.log("Account Number:", id);
					$.ajax({
						type: 'GET',
						url: './FetchLoanDetails',
						data: {id: id},
						success: function (data) {
							if (data.account_holderkey && data.encoded_key) {
								var holder_key = data.account_holderkey;
								var encodedKey = data.encoded_key;
								var id = data.id;
								location.href = 'loanSchedule?formmode=viewloanschedule1&id=' + id +
									'&holder_key=' + holder_key +
									'&encodedKey=' + encodedKey;
							} else {
								$('#mypopup22').modal('show');
								$("#popupmsg_body").html("No Data!...");
							}
						},
						error: function () {
							$('#errorMessage').text('Error fetching data');
							$('#errorModal').modal('show');
						}
					});
				}
			} else {
				alert("Element not found");
			}
		}

		function ledgerClosure(event) {
			console.log("Ledger Closure function called");
			event.preventDefault();
			var element = document.getElementById("closureaccountnumber");

			if (element) {
				var id = element.value.trim();

				if (!id) {
					$('#mypopup22').modal('show');
					$("#popupmsg_body").html("Account number is required!...");
				} else {
					location.href = 'accountLedger2?formmode=view&acct_num=' + id;
				}
			} else {
				alert("Element not found");
			}
		}






	</script>


</head>

<body>

	<div class="col-sm-2">
		<div th:insert="BGLSHeaderMenu :: header"></div>
	</div>
	<!---------------------User List Starts------------------------------------------------------->
	<!-- Start Content-->
	<div class="container-manager">
		<div class="row">
			<div class="col-sm-11 ml-5 mt-2">

				<div th:if="${formmode}=='list'">
					<div class="card-header" style="background-color: #e9ecef; height: 50px; padding-left: 5px;">
						<div class="float-left">
							<h6 id="loanHeader" style="font-size: 1.2rem; color: black;" class="ml-4">LOAN PRE - CLOSURE
							</h6>
						</div>

						<input type="hidden" id="hidden_acct_name" value="" style="display: none;">

						<!-- <div class="float-right">
							<button class="btn-primary big-btn" id="repaymentschedule" onclick="schedulePreClosure(event)"
								style="display: inline-block;">
								SCHEDULER
							</button>
							<button class="btn-primary big-btn" id="ledgerschedule" onclick="ledgerPreClosure(event)"
								style="display: inline-block;">
								LEDGER
							</button>
							<button class="btn-primary big-btn" onclick="showPreClosure();">PRE
								- CLOSURE</button>
								<button class="btn-primary big-btn" id="repaymentschedule" onclick="schedulePreClosure(event)"
								style="display: inline-block;">
								SCHEDULER
							</button>
							<button class="btn-primary big-btn" id="ledgerschedule" onclick="ledgerPreClosure(event)"
								style="display: inline-block;">
								LEDGER
							</button>
							<button class="btn-primary big-btn" onclick="showClosure();">CLOSURE</button>
						</div> -->

						<div class="float-right">
							<!-- PRE-CLOSURE BUTTONS -->
							<button class="btn-primary big-btn" id="preRepaymentSchedule"
								onclick="schedulePreClosure(event)" style="display: none;">
								SCHEDULER
							</button>
							<button class="btn-primary big-btn" id="preLedgerSchedule" onclick="ledgerPreClosure(event)"
								style="display: none;">
								LEDGER
							</button>
							<button class="btn-primary big-btn" onclick="showPreClosure()">PRE - CLOSURE</button>


							<!-- CLOSURE BUTTONS -->
							<button class="btn-primary big-btn" id="closeRepaymentSchedule"
								onclick="scheduleClosure(event)" style="display: none;">
								SCHEDULER
							</button>
							<button class="btn-primary big-btn" id="closeLedgerSchedule" onclick="ledgerClosure(event)"
								style="display: none;">
								LEDGER
							</button>
							<button class="btn-primary big-btn" onclick="showClosure()">CLOSURE</button>

						</div>


					</div>

					<div class="card-body border" id="preclosuredatas">

						<!-- Main Row for Transaction Type and Account Type Sections in a Single Row -->
						<!-- Section Heading: Date Range -->
						<div class="row formline mt-3 " id="fromtovalues" style="padding-left: 20px;">
							<!-- From Date -->
							<div class="col-sm-1">Account ID</div>
							<div class="col-sm-2">
								<!-- Input for selected account number -->
								<input type="text" id="precosureaccount" name="acct_num" readonly
									placeholder="Select Account" />

								<!-- Search button -->
								<button type="button" onclick="openModalpreclosure(this)">
									<i class="fa fa-search"></i>
								</button>
								<input type="text" th:each="ref : ${booking}" id="acct_num121" style="display: none;" />
							</div>

							<div class="col-sm-1">Account Name</div>
							<div class="col-sm-2">
								<input type="text" name="acct_name" id="preclosurename" autocomplete="off" />
							</div>

							<div class="col-sm-1">Date of Closure</div>
							<div class="col-sm-2">
								<input type="date" name="date_closure" placeholder="dd-mm-yyyy" id="date_closure" />
							</div>

							<div class="col-sm-1">Loan Balance</div>
							<div class="col-sm-2">
								<input type="text" name="loan_bal" id="loan_bal" autocomplete="off" />
							</div>
						</div>
						<div class="row formline mt-3 " id="fromtovalues" style="padding-left: 20px;">
							<div class="col-sm-9"></div>
							<div class="col-sm-1">Closure Balance</div>
							<div class="col-sm-2">
								<input type="text" name="loan_bal" id="acct_balancedatas" autocomplete="off" />
							</div>
						</div>

						<div class="mt-4" style="display: flex; justify-content: right; margin-bottom: 10px;">
							<img th:src="@{/images/add.png}" aria-hidden="true"
								style="cursor: pointer; width: 20px; height: 20px; margin-right: 10px;"
								onclick="addloanRow()" alt="Add"> <img th:src="@{/images/MinusIcon.png}"
								aria-hidden="true" style="cursor: pointer; width: 20px; height: 20px;"
								onclick="deleteloanRow()" alt="Remove">
						</div>

						<div style="max-height: 365px; overflow-y: auto; display: block;">
							<table class="table table-bordered table-sm mt-2"
								style="margin-bottom: 0px; font-size: initial; width: 100%;" id="serviceflowIdTable">
								<thead class="thead-light"
									style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
									<tr>
										<th>Flow Date</th>
										<th>Flow ID</th>
										<th>Flow Code</th>
										<th style="text-align: center;">Flow Amt</th>
										<th>Acct ID</th>
										<th>Acct Name</th>
									</tr>
								</thead>
								<tbody id="flowIdTbodynew">
									<!-- dynamic rows -->
								</tbody>
							</table>
						</div>

					</div>

					<div class="card-body border" style="display: none;" id="closuredatas">

						<!-- Main Row for Transaction Type and Account Type Sections in a Single Row -->
						<!-- Section Heading: Date Range -->
						<div class="row formline mt-3 " id="fromtovalues" style="padding-left: 20px;">
							<!-- From Date -->
							<div class="col-sm-1">Account No</div>
							<div class="col-sm-2">
								<!-- Input for selected account number -->
								<input type="text" id="closureaccountnumber" name="acct_num" readonly
									placeholder="Select Account" />

								<!-- Search button -->
								<button type="button" onclick="openModalclosure(this)">
									<i class="fa fa-search"></i>
								</button>
								<input type="text" th:each="ref : ${booking}" id="acct_num121" style="display: none;" />
							</div>

							<div class="col-sm-1">Account Name</div>
							<div class="col-sm-2">
								<input type="text" name="acct_name" id="closureaccountname" autocomplete="off" />
							</div>

							<div class="col-sm-1">Date of Closure</div>
							<div class="col-sm-2">
								<input type="date" name="date_closure" id="date_closure" />
							</div>

							<div class="col-sm-1">Loan Balance</div>
							<div class="col-sm-2">
								<input type="text" name="loan_bal" id="loan_bal1" autocomplete="off" />
							</div>
						</div>
						<div class="row formline mt-3 " id="fromtovalues" style="padding-left: 20px;">
							<div class="col-sm-9"></div>
							<div class="col-sm-1">Closure Balance</div>
							<div class="col-sm-2">
								<input type="text" name="loan_bal" id="acct_balancedatas1" autocomplete="off" />
							</div>
						</div>
						<!-- Table -->

						<div class="mt-4" style="display: flex; justify-content: right; margin-bottom: 10px;">
							<img th:src="@{/images/add.png}" aria-hidden="true"
								style="cursor: pointer; width: 20px; height: 20px; margin-right: 10px;"
								onclick="addloanRowclosure()" alt="Add"> <img th:src="@{/images/MinusIcon.png}"
								aria-hidden="true" style="cursor: pointer; width: 20px; height: 20px;"
								onclick="deleteloanRowclosure()" alt="Remove">
						</div>

						<table class="table table-bordered table-sm mt-2"
							style="margin-bottom: 0px; font-size: initial;" id="serviceflowIdTable">
							<thead class="thead-light">
								<tr>
									<th>Flow Date</th>
									<th>Flow ID</th>
									<th>Flow Code</th>
									<th>Flow Amt</th>
									<th>Acct ID</th>
									<th>Acct Name</th>
								</tr>
							</thead>

							<tbody id="flowIdTbodynew1">

							</tbody>
						</table>
					</div>

					<div class="card-footer text-center" style="background-color: #e9ecef;">
						<button class="btn-primary big-btn" onclick="Home();">Home</button>
						<button class="btn-primary big-btn" id="preclosuresubmit"
							onclick="handleCheckboxClickCollectiondata();" style="display:none;">
							Submit
						</button>
						<button class="btn-primary big-btn" id="closuresubmit"
							onclick="handleCheckboxClickCollectiondata1();" style="display:none;">
							Submit
						</button>
						<button class="btn-primary big-btn" onclick="back();">Back</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade" data-backdrop="false" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true"
		id="confirmation_modal">
		<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-body" style="text-align: center">
					<p id="popupmsg_body">Do you want to continue?</p>
					<button type="button" class="btn btn-primary" id="confirmYesBtn" data-dismiss="modal">
						Yes
					</button>
					<button type="button" class="btn btn-secondary" id="confirmNoBtn" data-dismiss="modal">
						No
					</button>
				</div>
			</div>
		</div>
	</div>



	<div class="modal fade" id="alertERE">
		<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content" style="background-color: white;">
				<div class="menu-title-header">
					<div class="modal-title" id="exampleModalLabel" style="text-align: center; color: white;">ACCOUNT
						DETAILS</div>
				</div>
				<div class="modal-body">
					<table class="table table-bordered table-hover table-sm">
						<thead>
							<tr style="text-align: center;">
								<th style="font-weight: bold;">SOL ID</th>
								<th style="font-weight: bold;">SOL DESCRIPTION</th>
								<th style="font-weight: bold;">SELECT</th>
							</tr>
						</thead>
						<tbody id="trancheDetList">
							<tr th:each="accvals : ${solvalues}">
								<td style="text-align: left;" th:text="${accvals[0]}"></td>
								<td style="text-align: left;" th:text="${accvals[1]}"></td>
								<td style="text-align: center;"><input type="radio" name="radioGroup"
										th:data-value1="${accvals[0]}" th:data-value2="${accvals[1]}"
										onclick="requestvalue(this);" />
								</td>

							</tr>
						</tbody>
					</table>
				</div>
				<div class="card-footer text-center">
					<button type="button" class="btn-primary big-btn" id="selectedAccount" onclick="closemodal();"
						style="color: white;">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ------------------------------------Account Number Mdal---------------------------------- -->

	<div id="myModal" class="modal" style="font-size:120%;">
		<div class="modal-content1 filterable">
			<!-- Header -->
			<div class="d-flex justify-content-between align-items-center filterable mb-2">
				<h5 class="modal-title">Account Details</h5>
				<div>
					<button class="btn btn-primary btn-filter">Filter</button>
				</div>
			</div>

			<!-- Body -->
			<div class="modal-body">
				<form id="uploadForm1" method="post" autocomplete="off">
					<table class="table table-bordered table-sm">
						<thead>
							<tr class="filters">
								<th style="width: 25%;">
									<input type="text" class="form-control font-weight-bold" placeholder="Account ID"
										disabled>
								</th>
								<th style="width: 35%;">
									<input type="text" class="form-control font-weight-bold" placeholder="Account Name"
										disabled>
								</th>
								<th style="width: 20%;">
									<input type="text" class="form-control font-weight-bold" placeholder="Currency"
										disabled>
								</th>
								<th style="width: 20%;">
									<input type="text" class="form-control font-weight-bold" placeholder="Action"
										disabled>
								</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="salpay : ${booking}" th:data-acct_num="${salpay[0]}"
								th:data-acct_name="${salpay[1]}" th:data-acct_crncy="${salpay[3]}"
								onclick="setAccountDetails(this)">
								<td th:text="${salpay != null ? salpay[0] : ''}"></td>
								<td th:text="${salpay != null ? salpay[1] : ''}"></td>
								<td th:text="${salpay != null ? salpay[3] : ''}"></td>
								<td class="text-center"><input type="radio" /></td>
							</tr>
						</tbody>
					</table>
				</form>
			</div>

			<!-- Footer -->
			<div class="modal-footer justify-content-center">
				<button type="button" class="btn btn-primary big-btn" onclick="closeModal(this);">Close</button>
			</div>
		</div>
	</div>

	<div id="myModalpreclosure" class="modal" style="font-size:120%;">
		<div class="modal-content1">
			<div class="close text-right" onclick="closeModalpreclosure(this);">&times;</div>
			<div class="panel panel-primary filterable">

				<!-- FILTER BUTTON -->
				<button type="button" class="btn text-white btn-filter btn-primary float-right">
					Filter
				</button>

				<div style="max-height: 350px; overflow-y: auto;">
					<table class="table table-bordered table-sm">
						<thead>
							<tr class="filters">
								<th>
									<input type="text" id="filterAccountNumberpreclosure"
										class="form-control font-weight-bold" placeholder="Account Number" readonly>
								</th>
								<th>
									<input type="text" id="filterAccountNamepreclosure"
										class="form-control font-weight-bold" placeholder="Account Name" readonly>
								</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="ref : ${preclosure}" onclick="selectAccountpreclosure(this)">
								<td th:text="${ref[0]}"></td>
								<td th:text="${ref[1]}"></td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="text-center mt-2">
					<button type="button" class="btn-primary big-btn" onclick="closeModalpreclosure(this);">
						Close
					</button>
				</div>
			</div>
		</div>
	</div>

	<div id="myModalclosure" class="modal" style="font-size:120%;">
		<div class="modal-content1">
			<!-- <div class="close text-right" onclick="closeModalclosure(this);">&times;</div> -->
			<div class="panel panel-primary filterable">

				<!-- FILTER BUTTON -->
				<button type="button" class="btn text-white btn-filter btn-primary float-right">
					Filter
				</button>

				<div style="max-height: 350px; overflow-y: auto;">
					<table class="table table-bordered table-sm">
						<thead>
							<tr class="filters">
								<th>
									<input type="text" id="filterAccountNumberclosure"
										class="form-control font-weight-bold" placeholder="Account Number" readonly>
								</th>
								<th>
									<input type="text" id="filterAccountNameclosure"
										class="form-control font-weight-bold" placeholder="Account Name" readonly>
								</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="ref : ${closure}" onclick="selectAccountclosure(this)">
								<td th:text="${ref[0]}"></td>
								<td th:text="${ref[1]}"></td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="text-center mt-2">
					<button type="button" class="btn-primary big-btn" onclick="closeModalclosure(this);">
						Close
					</button>
				</div>
			</div>
		</div>
	</div>


	<!-- Success Modal -->
	<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="successModalLabel">Success</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
						id="successModalCloseBtn"></button>
				</div>
				<div class="modal-body" id="successModalBody">
					<!-- Message inserted by JS -->
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="successModalCloseBtnFooter">Close</button>
				</div>
			</div>
		</div>
	</div>

</body>

</html>